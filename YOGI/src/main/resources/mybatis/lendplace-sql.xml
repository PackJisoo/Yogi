<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="lendplace">

<resultMap type="LendplaceModel" id="lendplaceRes">
      <result property="l_no" column="L_NO" />
      <result property="l_subject" column="L_SUBJECT" />
      <result property="l_addr" column="L_ADDR" />
      <result property="l_content" column="L_CONTENT" />
      <result property="l_rep_img" column="L_REP_IMG" />
      <result property="l_enable" column="L_ENABLE" />
      <result property="l_payment" column="L_PAYMENT" />
      <result property="l_sdate" column="L_SDATE" />
      <result property="l_edate" column="L_EDATE" />
      <result property="l_rate" column="L_RATE" />
   </resultMap>


<!-- 장소목록 조회 -->
<select id="selectLendplaceList" resultType="hashmap" parameterType="hashmap">
		SELECT 
			L_NO, 
			L_SUBJECT, 
			L_ADDR, 
			L_CONTENT, 
			L_REP_IMG, 
			L_ENABLE, 
			L_PAYMENT,
			TO_CHAR(L_SDATE,'YYYY-MM-DD') AS L_SDATE, 
			TO_CHAR(L_EDATE,'YYYY-MM-DD') AS L_EDATE, 
			L_RATE
		FROM LENDPLACE
		<where>
			<if test="searchWord != null">
				<![CDATA[
				(L_SUBJECT like '%' || #{searchWord} || '%' or L_CONTENT like '%' || #{searchWord} || '%')
				]]>
			</if>
			<if test="searchAddr != null">
				<![CDATA[
				AND REGEXP_LIKE(L_ADDR,#{searchAddr})
				]]>
			</if>
			<if test="min_pay != null and max_pay != null">
				<![CDATA[
				AND ((L_PAYMENT >= #{min_pay} and #{max_pay} >= L_PAYMENT))
				]]>
			</if>
			<if test="l_sdate != null and l_edate != null">
				<![CDATA[
				AND ((L_SDATE >= #{l_sdate} and #{l_edate} >= L_EDATE))
				]]>
			</if>
		</where>
		ORDER BY L_NO DESC
</select> 

<!-- 장소상세페이지 조회 -->
<select id="selectLendplaceDetail" resultType="hashmap" parameterType="hashmap">
	<![CDATA[
		SELECT 
			L_NO, 
			L_SUBJECT, 
			L_ADDR, 
			L_CONTENT, 
			L_REP_IMG, 
			L_ENABLE, 
			L_PAYMENT,
			TO_CHAR(L_SDATE,'YYYY-MM-DD') AS L_SDATE, 
			TO_CHAR(L_EDATE,'YYYY-MM-DD') AS L_EDATE, 
			L_RATE,
			L_UDATE
		FROM LENDPLACE 
		WHERE L_NO = #{L_NO}
	]]>
</select>

<!-- 날짜 중복확인 -->
<select id="dateCheck" resultType="hashmap" parameterType="hashmap">
	<![CDATA[
		SELECT 
			TO_CHAR(U_DATE,'YYYY-MM-DD') AS U_DATE
		FROM PLACEBOOK
		WHERE L_NO = #{L_NO}
	]]>
</select>
	
<!-- 장소 등록 -->
<insert id="insertLendplace" parameterType="LendplaceModel">
   		INSERT INTO LENDPLACE (
   			L_NO,
			L_SUBJECT,
			L_ADDR,
			L_CONTENT,
			L_ENABLE,
			L_PAYMENT,
			L_SDATE,
			L_EDATE
			)
		VALUES (
			LENDPLACE_SEQ.NEXTVAL,
			#{L_SUBJECT},
			#{L_ADDR},
			#{L_CONTENT},
			#{L_ENABLE},
			#{L_PAYMENT},
			TO_DATE(#{L_SDATE},'YYYY-MM-DD'),
			TO_DATE(#{L_EDATE},'YYYY-MM-DD')
			)
</insert>

<!-- 장소 내용 수정 -->
<update id="updateLendplace" parameterType="hashmap" >
	<![CDATA[
		UPDATE LENDPLACE 
		SET
			L_SUBJECT = #{L_SUBJECT},
			L_CONTENT = #{L_CONTENT},
			L_REP_IMG = #{L_REP_IMG},
			L_ENABLE = #{L_ENABLE},
			L_PAYMENT = #{L_PAYMENT}
		WHERE L_NO = #{L_NO}
	]]>
</update>



<!-- 장소예약 신청 -->
<insert id="insertPlacebook" parameterType="hashmap">
	<![CDATA[
		INSERT INTO PLACEBOOK (
			PB_NO,
			L_NO,
			M_NO,
			PB_DATE,
			U_DATE )
		VALUES (
			PLACEBOOK_SEQ.NEXTVAL,
			#{L_NO},
			#{M_NO},
			TO_DATE(sysdate,'YYYY-MM-DD'),
			TO_DATE(#{U_DATE},'YYYY-MM-DD')
			)
	]]>
</insert>

<!-- 예약현황 증가 -->
<update id="upCountUdate" parameterType="hashmap">
 	UPDATE 
 		LENDPLACE 
 	SET L_UDATE = L_UDATE + 1 
 	WHERE L_NO = #{L_NO}
</update>

<!-- 장소예약 신청 취소 -->
<delete id="deletePlacebook" parameterType="hashmap">
	<![CDATA[
		DELETE
		FROM PLACEBOOK
		WHERE L_NO = #{L_NO}
		AND U_DATE = TO_DATE(#{U_DATE},'YYYY-MM-DD') 
		AND M_NO = #{M_NO}
	]]>
</delete>

<!-- 예약현황 감소 -->
<update id="dwCountUdate" parameterType="hashmap">
 	UPDATE 
 		LENDPLACE 
 	SET L_UDATE = L_UDATE - 1 
 	WHERE L_NO = #{L_NO} 
</update>

<!-- 장소 삭제 -->
<delete id="deleteLendplace" parameterType="hashmap">
	<![CDATA[
		DELETE
		FROM LENDPLACE
		WHERE L_NO = #{L_NO}
	]]>
</delete>


<!-- 장소후기 입력 -->
<insert id="insertReview">
	<![CDATA[
		INSERT INTO REVIEW (
			R_NO,
			R_CONTENT,
			R_RATING,
			R_DATE,
			L_NO,
			M_NO )
		VALUES (
			REVIEW_SEQ.NEXTVAL,
			#{R_CONTENT},
			#{R_RATING},
			sysdate,
			#{L_NO},
			#{M_NO} )
	]]>
</insert>


<!-- 장소후기 삭제 -->
<delete id="deleteReview">
	<![CDATA[
		DELETE
		FROM REVIEW
		WHERE R_NO = #{R_NO}
	]]>
</delete>


</mapper>

